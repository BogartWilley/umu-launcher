id: org.openwinecomponents.umu.umu-launcher
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '23.08'
x-gl-version: &gl-version '1.4'
x-gl-versions: &gl-versions 23.08;23.08-extra;1.4
x-gl-merge-dirs: &gl-merge-dirs vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
sdk: org.freedesktop.Sdk
command: umu-run
separate-locales: false

sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386

finish-args:
  - --allow=devel
  - --allow=multiarch
  - --device=all
  - --allow=bluetooth
  - --allow=per-app-dev-shm
  - --env=PATH=/app/bin:/app/utils/bin:/usr/bin:/usr/lib/extensions/vulkan/MangoHud/bin:/usr/lib/extensions/vulkan/gamescope/bin:/usr/lib/extensions/vulkan/OBSVkCapture/bin
  - --filesystem=xdg-data/lutris:rw
  - --filesystem=xdg-data/Steam:rw
  - --filesystem=xdg-data/applications:rw
  - --filesystem=~/.steam:rw
  - --filesystem=~/Games:rw
  - --filesystem=~/.local/share/Steam:rw
  - --filesystem=~/.var/app/com.valvesoftware.Steam:rw
  - --filesystem=~/.var/app/org.openwinecomponents.umu.umu-launcher:rw
  - --filesystem=xdg-documents
  - --filesystem=xdg-desktop
  - --filesystem=xdg-download
  - --env=TZ=
  - --unset-env=TZ
  - --env=LC_ADDRESS=C
  - --env=LC_COLLATE=C
  - --env=LC_MONETARY=C
  - --env=LC_MEASUREMENT=C
  - --env=LC_NAME=C
  - --env=LC_NUMERIC=C
  - --env=LC_TELEPHONE=C
  - --env=SDL_VIDEODRIVER=
  - --unset-env=SDL_VIDEODRIVER
  - --env=DBUS_FATAL_WARNINGS=0
  - --env=XDG_CONFIG_DIRS=/etc/xdg:/usr/lib/x86_64-linux-gnu/GL:/usr/lib/i386-linux-gnu/GL
  # Wine uses UDisks2 to enumerate disk drives
  - --system-talk-name=org.freedesktop.UDisks2
  # should fix access to SD card on the deck
  - --filesystem=/run/media
  # There are still quite a few users using /mnt/ for external drives
  - --filesystem=/mnt
  # should fix steamdeck controler navigation
  - --filesystem=/run/udev:ro
  # should fix discord rich presence
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --persist=.
  - --share=ipc
  - --socket=wayland
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # Required for bwrap to work
  - --talk-name=org.freedesktop.portal.Background
  # --- Steam ---
  # Pressure Vessel
  # See https://github.com/flathub/com.valvesoftware.Steam/commit/0538256facdb0837c33232bc65a9195a8a5bc750
  - --env=XDG_DATA_DIRS=/app/share:/usr/lib/extensions/vulkan/share:/usr/share:/usr/share/runtime/share:/run/host/user-share:/run/host/share:/usr/lib/pressure-vessel/overrides/share

add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version

  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: *gl-merge-dirs
    download-if: active-gl-driver
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.GL32.Debug:
    directory: lib/debug/lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    merge-dirs: *gl-merge-dirs
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.VAAPI.Intel.i386:
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: *runtime-version
    versions: *runtime-version
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-intel-gpu
    autoprune-unless: have-intel-gpu

  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: *runtime-version
    no-autodownload: true
    autodelete: false

  org.freedesktop.Platform.ffmpeg_full.i386:
    directory: lib32/ffmpeg
    add-ld-path: .
    version: *runtime-version
    no-autodownload: true
    autodelete: false

  com.valvesoftware.Steam.CompatibilityTool:
    subdirectories: true
    directory: share/steam/compatibilitytools.d
    version: stable
    versions: stable;beta;test
    no-autodownload: true
    autodelete: true

  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: stable
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin;lib/python3.10/site-packages;share/vulkan/explicit_layer.d;share/vulkan/implicit_layer.d;share/steam/compatibilitytools.d;
    no-autodownload: true
    autodelete: true

modules:
  # --- umu ---
  - name: umu-run
    buildsystem: simple
    build-commands:
      - |
        git submodule update --init --recursive
        ./configure.sh --prefix=/app
        make FLATPAK=xtrue install
    sources:
      - type: git
        url: https://github.com/Open-Wine-Components/umu-launcher.git
        branch: flatpak_work

  - name: platform-bootstrap
    buildsystem: simple
    build-commands:
      - |
        set -e
        mkdir -p /app/bin
        mkdir -p /app/lib/i386-linux-gnu
        mkdir -p /app/lib/i386-linux-gnu/GL
        mkdir -p /app/lib/i386-linux-gnu/dri/intel-vaapi-driver
        mkdir -p /app/lib/debug/lib/i386-linux-gnu
        mkdir -p /app/lib/debug/lib/i386-linux-gnu/GL
        install -Dm644 -t /app/etc ld.so.conf
        mkdir -p /app/lib{,32}/ffmpeg
        mkdir -p /app/share/steam/compatibilitytools.d
        mkdir -p /app/utils /app/share/vulkan
        ln -srv /app/{utils/,}share/vulkan/explicit_layer.d
        ln -srv /app/{utils/,}share/vulkan/implicit_layer.d
        mkdir -p /app/links/lib
        ln -srv /app/lib /app/links/lib/x86_64-linux-gnu
        ln -srv /app/lib32 /app/links/lib/i386-linux-gnu
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          # We just make any GL32 extension have higher priority
          include /run/flatpak/ld.so.conf.d/app-*-org.freedesktop.Platform.GL32.*.conf
          /app/lib32
          /app/lib/i386-linux-gnu
          /lib64

  - name: python-flit-core  # needed by idna
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/15/d1/d8798b83e953fd6f86ca9b50f93eec464a9305b0661469c8234e61095481/flit_core-3.7.1.tar.gz
        sha256: 14955af340c43035dbfa96b5ee47407e377ee337f69e70f73064940d27d0a44f

  - name: python-ninja  # needed by dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j${FLATPAK_BUILDER_N_JOBS} -DARCHIVE_DOWNLOAD_DIR="${FLATPAK_BUILDER_BUILDDIR}"
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/00/99/5beedbf09e3ec6b617606df42d04c4251959caddbd98397cce21da4c52d1/ninja-1.10.2.3.tar.gz
        sha256: e1b86ad50d4e681a7dbdff05fc23bb52cb773edb90bc428efba33fa027738408
      - type: file
        url: https://github.com/Kitware/ninja/archive/v1.10.2.g51db2.kitware.jobserver-1.tar.gz
        sha256: 549c31ee596566b952c600e23eb9b8d39a4112cd5fdeb2e5a83370669176da40
    modules:
      - name: python-skbuild
        buildsystem: simple
        build-commands:
          - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
            .
        cleanup: ['*']
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/9e/e2/2e440c30e93fc5b505ee56169a4396b05e797a1daadb721aba429adbfd51/scikit-build-0.15.0.tar.gz
            sha256: e723cd0f3489a042370b9ea988bbb9cfd7725e8b25b20ca1c7981821fcf65fb9
        modules:
          - name: python-setuptools-scm
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                .
            cleanup: ['*']
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/d0/43/f038b5009f93bcd77b1b8da9e6d424b739ab17aec9726f3a99eba23d53ca/setuptools_scm-7.0.5.tar.gz
                sha256: 031e13af771d6f892b941adb6ea04545bbf91ebc5ce68c78aaf3fff6e1fb4844
            modules:
              - name: python-packaging
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                    .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz
                    sha256: dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb
                modules:
                  - name: python-pyparsing
                    buildsystem: simple
                    build-commands:
                      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
                    cleanup: ['*']
                    sources:
                      - type: archive
                        url: https://files.pythonhosted.org/packages/71/22/207523d16464c40a0310d2d4d8926daffa00ac1f5b1576170a32db749636/pyparsing-3.0.9.tar.gz
                        sha256: 2b020ecf7d21b687f219b71ecad3631f644a47f01403fa1d1036b0c6416d70fb
              - name: python-typing-extensions
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/9e/1d/d128169ff58c501059330f1ad96ed62b79114a2eb30b8238af63a2e27f70/typing_extensions-4.3.0.tar.gz
                    sha256: e6d2677a32f47fc7eb2795db1dd15c1f34eff616bcaf2cfb5e997f854fa1c4a6
              - name: python-tomli
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/c0/3f/d7af728f075fb08564c5949a9c95e44352e23dee646869fa104a3b2060a3/tomli-2.0.1.tar.gz
                    sha256: de526c12914f0c550d15924c62d72abc48d6fe7364aa87328337a31007fe8a4f
          - name: python-distro  # also needed by Lutris, do not add a cleanup property here!
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/b5/7e/ddfbd640ac9a82e60718558a3de7d5988a7d4648385cf00318f60a8b073a/distro-1.7.0.tar.gz
                sha256: 151aeccf60c216402932b52e40ee477a939f8d58898927378a02abbe852c1c39
  # --- python-xlib ---
  - name: python-xlib
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/source/p/python-xlib/python-xlib-0.33.tar.gz
        sha256: 55af7906a2c75ce6cb280a584776080602444f75815a7aff4d287bb2d7018b32


